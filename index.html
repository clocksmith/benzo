<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>⌬ Benzo v2</title>
    <style>
        :root {
            --bg-color: black;
            --text-color: white;
            --control-bg-color: black;
            --node-color: white;
            --edge-color: white;
            --switch-bg: black;
            --switch-thumb-bg: white;
            --switch-active-bg: white;
            --button-bg: black;
            --button-text-color: white;
            --button-hover-bg: white;
            --input-bg: black;
            --input-text-color: white;
            --input-border-color: white;
            --section-title-color: white;
            --script-control-bg: black;
            --slider-track-color: white;
            --slider-thumb-color: white;
            --message-color: white;
        }

        .light-mode {
            --bg-color: white;
            --text-color: black;
            --control-bg-color: #eee;
            --node-color: black;
            --edge-color: black;
            --switch-bg: white;
            --switch-thumb-bg: black;
            --switch-active-bg: black;
            --button-bg: white;
            --button-text-color: black;
            --button-hover-bg: #ccc;
            --input-bg: white;
            --input-text-color: black;
            --input-border-color: black;
            --section-title-color: black;
            --script-control-bg: #ddd;
            --slider-track-color: black;
            --slider-thumb-color: black;
            --message-color: black;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        body {
            font-family: sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        #controls {
            width: 300px;
            height: 100vh;
            padding: 20px;
            background-color: var(--control-bg-color);
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            align-items: stretch;
            border-right: 1px solid var(--text-color);
            box-sizing: border-box;
        }

        #controls h2 {
            color: var(--section-title-color);
            margin-bottom: 10px;
            text-align: center;
        }

        #canvas-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        #observatory {
            height: 300px;
            background-color: var(--control-bg-color);
            color: var(--text-color);
            padding: 10px;
            border-bottom: 1px solid var(--text-color);
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
        }

        #graphCanvas {
            flex-grow: 1;
            background-color: var(--bg-color);
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        #graphCanvas svg {
            display: block;
            width: 100%;
            height: 100%;
        }

        .node {
            fill: var(--node-color);
            stroke: none;
            cursor: pointer;
        }

        .node.selected {
            stroke: magenta;
            stroke-width: 3px;
        }

        .node.focus-node {
            fill: lime;
        }

        .edge {
            stroke: var(--edge-color);
            stroke-width: 1;
            fill: none;
        }

        .edge.focus-edge {
            stroke-dasharray: 5, 5;
            fill: lime;
        }


        #darkModeToggleContainer {
            position: absolute;
            top: 8px;
            right: 8px;
            cursor: pointer;
        }

        #darkModeToggleContainer span {
            font-size: 2em;
            display: none;
        }

        #darkModeToggleContainer.dark-mode #darkModeIcon,
        #darkModeToggleContainer:not(.dark-mode) #lightModeIcon {
            display: inline;
        }


        button,
        select,
        input[type="text"],
        input[type="range"] {
            background-color: var(--button-bg);
            color: var(--button-text-color);
            border: 1px solid var(--text-color);
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s, color: 0.3s;
            outline: none;
            font-family: monospace;
            font-weight: lighter;
            width: calc(100% - 24px);
            box-sizing: border-box;
            text-align: center;
            margin: 4px 0;
            display: block;
        }

        button:hover {
            background-color: var(--button-hover-bg);
            color: var(--button-bg);
        }

        .light-mode button:hover {
            color: var(--button-bg);
        }

        button:active {
            background-color: var(--button-text-color);
            color: var(--button-bg);
        }

        input[type="text"],
        select {
            padding: 6px 10px;
            cursor: text;
            text-align: left;
        }

        input[type="text"]::placeholder {
            text-align: left;
        }

        input[type="text"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        input[type="range"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: calc(100% - 24px);
            height: 10px;
            background: transparent;
            cursor: pointer;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            background: var(--slider-track-color);
            height: 4px;
            border-radius: 2px;
        }

        input[type="range"]::-moz-range-track {
            background: var(--slider-track-color);
            height: 4px;
            border-radius: 2px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 16px;
            width: 16px;
            background-color: var(--slider-thumb-color);
            border-radius: 50%;
            margin-top: -6px;
        }

        input[type="range"]::-moz-range-thumb {
            -moz-appearance: none;
            appearance: none;
            height: 16px;
            width: 16px;
            background-color: var(--slider-thumb-color);
            border-radius: 50%;
        }


        .step-message {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            fill: var(--message-color);
            font-size: 1.2em;
            text-anchor: middle;
            dominant-baseline: hanging;
            y: 10px;
        }

        .step-message.visible {
            opacity: 1;
        }

        .message-history {
            fill: var(--message-color);
            opacity: 0.6;
            font-size: 0.8em;
            text-anchor: middle;
            dominant-baseline: hanging;
        }

        #observatoryRect {
            fill: var(--control-bg-color);
            stroke: var(--text-color);
            stroke-width: 1px;
        }

        #scriptControls {
            background-color: var(--script-control-bg);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        #playbackControls {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-top: 12px;
            margin-bottom: 12px;
        }

        #playbackControls button {
            margin: 0;
        }

        #speedControl label {
            display: block;
            margin-bottom: 8px;
        }

        #speedSlider {
            appearance: none;
            height: 4px;
            border: none;
        }

        #templatesSection>div,
        #graphActionsSection>div {
            margin-bottom: 16px;
        }

        #templatesSection h3,
        #graphActionsSection h3,
        #scriptControls h3 {
            color: var(--section-title-color);
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        #scriptControls h3 {
            margin-top: 0;
        }
    </style>
</head>

<body class="dark-mode">
    <div id="controls">
        <div id="darkModeToggleContainer" class="dark-mode">
            <span id="lightModeIcon">◑</span>
            <span id="darkModeIcon">◐</span>
        </div>

        <button id="resetButton">Reset All</button>

        <div id="scriptControls">
            <h3>Script Controls</h3>
            <select id="scriptSelector">
                <option value="">Select Script</option>
                <option value="ring_script">Ring Script</option>
                <option value="grid_script">Grid Script</option>
                <option value="path_script">Path Script</option>
                <option value="design_tasks_script">Design Tasks Script</option>
                <option value="gen_ui_script">GenUI Script</option>
            </select>
            <div id="playbackControls">
                <button id="stepBackwardButton">Back</button>
                <button id="playPauseButton">Play</button>
                <button id="stepForwardButton">Next</button>
            </div>
            <div id="speedControl">
                <label id="speedLabel" for="speedSlider">Speed (ms per step)</label>
                <input type="range" id="speedSlider" min="100" max="2000" value="500" step="50">
            </div>
            <span id="scriptStepDisplay">Step: -</span>
        </div>


        <div id="templatesSection">
            <h3>Templates</h3>
            <div>
                <input type="text" id="ringNodesInput" placeholder="[6, 12]" value='[6]'>
                <button id="addRingsButton">Add Circular Rings</button>
            </div>
            <div>
                <input type="text" id="triGridRingsInput" placeholder="3" value='3'>
                <button id="addTriGridButton">Add Triangular Grid</button>
            </div>
        </div>

        <div id="graphActionsSection">
            <h3>Graph Actions</h3>
            <div><button id="addNodeButton">Add Node</button></div>
            <div><button id="removeNodeButton">Remove Node</button></div>
            <div><button id="connectNodesButton">Connect Nodes</button></div>
        </div>

    </div>

    <div id="canvas-container">
        <div id="observatory">
            <svg id="observatorySvg" width="100%" height="100%">
                <!-- Observatory content will be rendered here -->
            </svg>
        </div>

        <div id="graphCanvas">
            <svg id="mainSvg" width="100%" height="100%">
                <!-- Graph content will be rendered here -->
            </svg>
        </div>
    </div>

    <script>
        const graphCanvas = document.getElementById('graphCanvas');
        const controls = document.getElementById('controls');
        const darkModeToggleContainer = document.getElementById('darkModeToggleContainer');
        const resetButton = document.getElementById('resetButton');
        const addNodeButton = document.getElementById('addNodeButton');
        const removeNodeButton = document.getElementById('removeNodeButton');
        const connectNodesButton = document.getElementById('connectNodesButton');
        const ringNodesInput = document.getElementById('ringNodesInput');
        const addRingsButton = document.getElementById('addRingsButton');
        const triGridRingsInput = document.getElementById('triGridRingsInput');
        const addTriGridButton = document.getElementById('addTriGridButton');
        const observatory = document.getElementById('observatory');
        const scriptSelector = document.getElementById('scriptSelector');
        const stepBackwardButton = document.getElementById('stepBackwardButton');
        const playPauseButton = document.getElementById('playPauseButton');
        const stepForwardButton = document.getElementById('stepForwardButton');
        const speedSlider = document.getElementById('speedSlider');
        const speedLabel = document.getElementById('speedLabel');
        const scriptStepDisplay = document.getElementById('scriptStepDisplay');
        const observatorySvg = document.getElementById('observatorySvg');
        const mainSvg = document.getElementById('mainSvg');

        let nodes = [];
        let edges = [];
        let nextNodeId = 0;
        let nextEdgeId = 0;
        let selectedNodeIds = [];
        let focusNodes = [];
        let focusEdges = [];
        let nextFocusNodeId = 0;
        let nextFocusEdgeId = 0;
        let isConnectingNodes = false;
        let darkMode = true;
        let currentScript = null;
        let scriptSteps = [];
        let currentStepIndex = -1;
        let isPlaying = false;
        let playSpeed = 500;
        let playInterval;
        let stepDelay = 500;
        let messageHistoryArray = [];
        let selectedNodeIdForConnection = null;
        let currentStepMessage;
        let messageHistory;

        const scripts = {
            "ring_demo": {
                "step1": { "reset": null, "message": "Reset graph for path script" },
                "step2": { "add_circular_rings": [8], "message": "Adding initial ring" },
                "step3": { "connect_nodes": { "node1": "node-0", "node2": "node-1" }, "message": "Connect 0 and 1" },
                "step4": { "connect_nodes": { "node1": "node-1", "node2": "node-2" }, "message": "Connect 1 and 2" },
                "step5": { "connect_nodes": { "node1": "node-2", "node2": "node-3" }, "message": "Connect 2 and 3" },
                "step6": { "connect_nodes": { "node1": "node-3", "node2": "node-4" }, "message": "Connect 3 and 4" },
                "step7": { "connect_nodes": { "node1": "node-4", "node2": "node-5" }, "message": "Connect 4 and 5" },
                "step8": { "connect_nodes": { "node1": "node-5", "node2": "node-6" }, "message": "Connect 5 and 6" },
                "step9": { "connect_nodes": { "node1": "node-6", "node2": "node-7" }, "message": "Connect 6 and 7" },
                "step10": { "connect_nodes": { "node1": "node-7", "node2": "node-0" }, "message": "Connect 7 and 0 to close ring" },
                "step11": { "connect_nodes": { "node1": "node-0", "node2": "node-2" }, "message": "Adding diagonals" },
                "step12": { "connect_nodes": { "node1": "node-2", "node2": "node-4" }, "message": " " },
                "step13": { "connect_nodes": { "node1": "node-4", "node2": "node-6" }, "message": " " },
                "step14": { "connect_nodes": { "node1": "node-6", "node2": "node-0" }, "message": " " },
                "step15": { "select_path": ["node-0", "node-1", "node-2", "node-3", "node-4", "node-5", "node-6", "node-7"], "message": "Selecting the ring path" },
                "step16": { "copy_move_to_focus": null, "message": "Copying ring path to observatory" },
                "step17": { "straighten_path": null, "message": "Straightening the ring path in observatory" },
                "step18": { "compress_path": null, "message": "Compressing the straightened path in observatory" },
                "step19": { "add_compressed_path_to_graph": null, "message": "Adding compressed path back to main graph" },
                "step20": { "select_path": ["node-0", "node-2", "node-4", "node-6"], "message": "Selecting diagonal path" },
                "step21": { "copy_move_to_focus": null, "message": "Copying diagonal path to observatory" },
                "step22": { "straighten_path": null, "message": "Straightening diagonal path in observatory" },
                "step23": { "compress_path": null, "message": "Compressing diagonal path in observatory" },
                "step24": { "add_compressed_path_to_graph": null, "message": "Adding diagonal compressed path to graph" },
                "step25": { "select_path": ["node-1", "node-3", "node-5", "node-7"], "message": "Selecting other diagonal path" },
                "step26": { "copy_move_to_focus": null, "message": "Copying other diagonal path to observatory" },
                "step27": { "straighten_path": null, "message": "Straightening other diagonal path in observatory" },
                "step28": { "compress_path": null, "message": "Compressing other diagonal path in observatory" },
                "step29": { "add_compressed_path_to_graph": null, "message": "Adding compressed other diagonal path to graph" },
                "step30": { "message": "Path script complete!" }
            },
            "grid_demo": {
                "step1": { "reset": null, "message": "Reset graph for path2 script" },
                "step2": { "add_triangular_grid": 3, "message": "Adding initial triangular grid" },
                "step3": { "connect_nodes": { "node1": "node-0", "node2": "node-1" }, "message": "Connect 0 and 1" },
                "step4": { "connect_nodes": { "node1": "node-1", "node2": "node-2" }, "message": "Connect 1 and 2" },
                "step5": { "connect_nodes": { "node1": "node-2", "node2": "node-3" }, "message": "Connect 2 and 3" },
                "step6": { "connect_nodes": { "node1": "node-3", "node2": "node-4" }, "message": "Connect 3 and 4" },
                "step7": { "connect_nodes": { "node1": "node-4", "node2": "node-5" }, "message": "Connect 4 and 5" },
                "step8": { "connect_nodes": { "node1": "node-5", "node2": "node-0" }, "message": "Connect 5 and 0" },
                "step9": { "select_path": ["node-0", "node-1", "node-2", "node-3", "node-4", "node-5"], "message": "Selecting the outer ring" },
                "step10": { "copy_move_to_focus": null, "message": "Copying ring to observatory" },
                "step11": { "straighten_path": null, "message": "Straightening the ring in observatory" },
                "step12": { "add_compressed_path_to_graph": null, "message": "Adding straightened path back to main graph" },
                "step13": { "connect_nodes": { "node1": "node-6", "node2": "node-7" }, "message": "Connect 6 and 7" },
                "step14": { "connect_nodes": { "node1": "node-7", "node2": "node-8" }, "message": "Connect 7 and 8" },
                "step15": { "connect_nodes": { "node1": "node-8", "node2": "node-9" }, "message": "Connect 8 and 9" },
                "step16": { "connect_nodes": { "node1": "node-9", "node2": "node-10" }, "message": "Connect 9 and 10" },
                "step17": { "connect_nodes": { "node1": "node-10", "node2": "node-11" }, "message": "Connect 10 and 11" },
                "step18": { "connect_nodes": { "node1": "node-11", "node2": "node-6" }, "message": "Connect 11 and 6" },
                "step19": { "message": "Path2 script complete!" }
            },
            "design_cuj_path": {
                "step1": { "reset": null, "message": "Resetting graph to visualize Design Task JSON" },
                "step2": { "add_triangular_grid": 5, "message": "Building a triangular grid.  Nodes will represent start/end points of CUJs." },
                "step3": { "message": "Mapping CUJ start/end points to grid nodes.  Edges will represent potential solutions." },

                // CUJ: identify_font_from_image
                "step4": { "connect_nodes": { "node1": "node-0", "node2": "node-1" }, "message": "CUJ: Identify Font (Manual).  Connecting start (node-0) and end (node-1) nodes." },
                "step5": { "connect_nodes": { "node1": "node-0", "node2": "node-2" }, "message": "CUJ: Identify Font (Agent). Connecting start (node-0) and end (node-2) nodes." },

                // CUJ: convert_svg_to_optimized_raster
                "step6": { "connect_nodes": { "node1": "node-3", "node2": "node-4" }, "message": "CUJ: Convert SVG (Manual). Connecting start (node-3) and end (node-4) nodes." },
                "step7": { "connect_nodes": { "node1": "node-3", "node2": "node-5" }, "message": "CUJ: Convert SVG (Script). Connecting start (node-3) and end (node-5) nodes." },
                "step8": { "connect_nodes": { "node1": "node-3", "node2": "node-6" }, "message": "CUJ: Convert SVG (Agent). Connecting start (node-3) and end (node-6) nodes." },

                // CUJ: animate_svg_icons_basic_effects
                "step9": { "connect_nodes": { "node1": "node-7", "node2": "node-8" }, "message": "CUJ: Animate SVG Icons (Manual). Connecting start (node-7) and end (node-8) nodes." },
                "step10": { "connect_nodes": { "node1": "node-7", "node2": "node-9" }, "message": "CUJ: Animate SVG Icons (Agent). Connecting start (node-7) and end (node-9) nodes." },

                // CUJ: generate_placeholder_content
                "step11": { "connect_nodes": { "node1": "node-10", "node2": "node-11" }, "message": "CUJ: Generate Placeholder (Manual).  Connecting start (node-10) and end (node-11) nodes." },
                "step12": { "connect_nodes": { "node1": "node-10", "node2": "node-12" }, "message": "CUJ: Generate Placeholder (LLM Text). Connecting start (node-10) and end (node-12) nodes." },
                "step13": { "connect_nodes": { "node1": "node-10", "node2": "node-13" }, "message": "CUJ: Generate Placeholder (AI Image). Connecting start (node-10) and end (node-13) nodes." },

                // CUJ: extract_colors_from_style_guide
                "step14": { "connect_nodes": { "node1": "node-14", "node2": "node-15" }, "message": "CUJ: Extract Colors (Manual). Connecting start (node-14) and end (node-15) nodes." },
                "step15": { "connect_nodes": { "node1": "node-14", "node2": "node-16" }, "message": "CUJ: Extract Colors (Agent). Connecting start (node-14) and end (node-16) nodes." },

                // More CUJs will be added later...

                "step16": { "message": "Initial CUJ connections established.  Preparing for scale visualization." },

                "step17": { "select_path": ["node-0", "node-3", "node-7", "node-10", "node-14"], "message": "Selecting start nodes of CUJs for scale title creation." },

                "step18": { "copy_move_to_focus": null, "message": "Copying selected start nodes to the observatory." },
                "step19": { "straighten_path": null, "message": "Straightening the copied nodes in the observatory." },
                // Don't compress, we'll re-use this straight line.
                "step20": { "add_node": { x: "center-150", y: "center-250" }, "message": "Adding 'Time Scale' title node." },
                "step21": { "connect_nodes": { "node1": "node-20", "node2": "focus-0" }, "message": "Connecting 'Time Scale' to the first focus node." },
                "step22": { "add_node": { x: "center", y: "center-250" }, "message": "Adding 'Pain Level Scale' title node." },
                "step23": { "connect_nodes": { "node1": "node-21", "node2": "focus-1" }, "message": "Connecting 'Pain Level Scale' title to the second focus node" },
                "step24": { "add_node": { x: "center+150", y: "center-250" }, "message": "Adding 'Complexity Scale' title node." },
                "step25": { "connect_nodes": { "node1": "node-22", "node2": "focus-2" }, "message": "Connecting 'Complexity Scale' title to third focus node." },
                "step26": { "add_node": { x: "center+300", y: "center-250" }, "message": "Adding 'Feedback Initial Scale' title node." },
                "step27": { "connect_nodes": { "node1": "node-23", "node2": "focus-3" }, "message": "Connecting 'Feedback Initial Scale' title to fourth focus node." },
                "step28": { "add_node": { x: "center+450", y: "center-250" }, "message": "Adding 'Feedback Refined Scale' title node." },
                "step29": { "connect_nodes": { "node1": "node-24", "node2": "focus-4" }, "message": "Connecting 'Feedback Refined Scale' title to fifth focus node." },


                "step30": { "message": "Scales added and connected.  Preparing to add more CUJs." },

                // CUJ: resize_crop_images_bulk
                "step31": { "add_node": {}, "message": "Adding start node for 'Resize/Crop Images (Manual)' CUJ." },
                "step32": { "add_node": {}, "message": "Adding end node for 'Resize/Crop Images (Manual)' CUJ." },
                "step33": { "connect_nodes": { "node1": "node-25", "node2": "node-26" }, "message": "Connecting nodes for 'Resize/Crop Images (Manual)' CUJ." },
                "step34": { "add_node": {}, "message": "Adding end node for 'Resize/Crop Images (Agent)' CUJ." },
                "step35": { "connect_nodes": { "node1": "node-25", "node2": "node-27" }, "message": "Connecting nodes for 'Resize/Crop Images (Agent)' CUJ." },

                // CUJ: generate_code_snippets_basic_ui
                "step36": { "add_node": {}, "message": "Adding start node for 'Generate Code Snippets (Manual)' CUJ." },
                "step37": { "add_node": {}, "message": "Adding end node for 'Generate Code Snippets (Manual)' CUJ." },
                "step38": { "connect_nodes": { "node1": "node-28", "node2": "node-29" }, "message": "Connecting nodes for 'Generate Code Snippets (Manual)' CUJ." },
                "step39": { "add_node": {}, "message": "Adding end node for 'Generate Code Snippets (Agent)' CUJ." },
                "step40": { "connect_nodes": { "node1": "node-28", "node2": "node-30" }, "message": "Connecting nodes for 'Generate Code Snippets (Agent)' CUJ." },

                // CUJ: find_replace_text_figma_files
                "step41": { "add_node": {}, "message": "Adding start node for 'Find/Replace Text (Manual)' CUJ." },
                "step42": { "add_node": {}, "message": "Adding end node for 'Find/Replace Text (Manual)' CUJ." },
                "step43": { "connect_nodes": { "node1": "node-31", "node2": "node-32" }, "message": "Connecting nodes for 'Find/Replace Text (Manual)' CUJ." },
                "step44": { "add_node": {}, "message": "Adding end node for 'Find/Replace Text (Plugin)' CUJ." },
                "step45": { "connect_nodes": { "node1": "node-31", "node2": "node-33" }, "message": "Connecting nodes for 'Find/Replace Text (Plugin)' CUJ." },

                // CUJ: organize_figma_layers_auto_group
                "step46": { "add_node": {}, "message": "Adding start node for 'Organize Figma Layers (Manual)'" },
                "step47": { "add_node": {}, "message": "Adding end node for 'Organize Figma Layers (Manual)'" },
                "step48": { "connect_nodes": { "node1": "node-34", "node2": "node-35" }, "message": "Connecting nodes for 'Organize Figma Layers (Manual)'." },
                "step49": { "add_node": {}, "message": "Adding end node for 'Organize Figma Layers (Plugin/Agent)'" },
                "step50": { "connect_nodes": { "node1": "node-34", "node2": "node-36" }, "message": "Connecting nodes for 'Organize Figma Layers (Plugin/Agent)'." },

                // CUJ: generate_alt_text_suggestions
                "step51": { "add_node": {}, "message": "Adding start node for 'Generate Alt Text (Manual)'" },
                "step52": { "add_node": {}, "message": "Adding end node for 'Generate Alt Text (Manual)'" },
                "step53": { "connect_nodes": { "node1": "node-37", "node2": "node-38" }, "message": "Connecting nodes for 'Generate Alt Text (Manual)'." },
                "step54": { "add_node": {}, "message": "Adding end node for 'Generate Alt Text (LLM Agent)'" },
                "step55": { "connect_nodes": { "node1": "node-37", "node2": "node-39" }, "message": "Connecting nodes for 'Generate Alt Text (LLM Agent)'. " },

                // CUJ: create_sticker_sheet_icon_library
                "step56": { "add_node": {}, "message": "Adding start node for 'Create Sticker Sheet (Manual)'" },
                "step57": { "add_node": {}, "message": "Adding end node for 'Create Sticker Sheet (Manual)'" },
                "step58": { "connect_nodes": { "node1": "node-40", "node2": "node-41" }, "message": "Connecting start and end nodes for 'Create Sticker Sheet (Manual)'." },
                "step59": { "add_node": {}, "message": "Adding end node for 'Create Sticker Sheet (Tool)'" },
                "step60": { "connect_nodes": { "node1": "node-40", "node2": "node-42" }, "message": "Connecting start and end nodes for 'Create Sticker Sheet (Tool)'. " },

                // CUJ: create_figma_file_from_engineer_prototype
                "step61": { "add_node": {}, "message": "Adding start node for 'Create Figma from Prototype (Manual)'" },
                "step62": { "add_node": {}, "message": "Adding end node for 'Create Figma from Prototype (Manual)'" },
                "step63": { "connect_nodes": { "node1": "node-43", "node2": "node-44" }, "message": "Connecting start and end nodes 'Create Figma from Prototype (Manual)'." },
                "step64": { "add_node": {}, "message": "Adding end node for 'Create Figma from Prototype (Tool)'" },
                "step65": { "connect_nodes": { "node1": "node-43", "node2": "node-45" }, "message": "Connecting start and end nodes for 'Create Figma from Prototype (Tool)'. " },

                // CUJ: generate_developer_specs_from_figma
                "step66": { "add_node": {}, "message": "Adding start node for 'Generate Developer Specs (Manual)'" },
                "step67": { "add_node": {}, "message": "Adding end node for 'Generate Developer Specs (Manual)'" },
                "step68": { "connect_nodes": { "node1": "node-46", "node2": "node-47" }, "message": "Connecting nodes for 'Generate Developer Specs (Manual)'." },
                "step69": { "add_node": {}, "message": "Adding end node for 'Generate Developer Specs (Plugin)'" },
                "step70": { "connect_nodes": { "node1": "node-46", "node2": "node-48" }, "message": "Connecting nodes for 'Generate Developer Specs (Plugin)'. " },

                // CUJ: create_basic_prototype_static_screens
                "step71": { "add_node": {}, "message": "Adding start node for 'Create Basic Prototype (Manual)'" },
                "step72": { "add_node": {}, "message": "Adding end node for 'Create Basic Prototype (Manual)'" },
                "step73": { "connect_nodes": { "node1": "node-49", "node2": "node-50" }, "message": "Connecting start and end nodes for 'Create Basic Prototype (Manual)'." },
                "step74": { "add_node": {}, "message": "Adding end node for 'Create Basic Prototype (AI-Assisted)'" },
                "step75": { "connect_nodes": { "node1": "node-49", "node2": "node-51" }, "message": "Connecting start and end nodes for 'Create Basic Prototype (AI-Assisted)'. " },

                // CUJ: generate_social_media_assets_templates
                "step76": { "add_node": {}, "message": "Adding start node for 'Generate Social Media Assets (Manual)'" },
                "step77": { "add_node": {}, "message": "Adding end node for 'Generate Social Media Assets (Manual)'" },
                "step78": { "connect_nodes": { "node1": "node-52", "node2": "node-53" }, "message": "Connecting start and end nodes for 'Generate Social Media Assets (Manual)'." },
                "step79": { "add_node": {}, "message": "Adding end node for 'Generate Social Media Assets (Tool/Agent)'" },
                "step80": { "connect_nodes": { "node1": "node-52", "node2": "node-54" }, "message": "Connecting start and end nodes for 'Generate Social Media Assets (Tool/Agent)'. " },

                "step81": { "message": "More CUJs added.  Continuing to connect more CUJs..." },

                // CUJ: translate_design_text_multiple_languages
                "step82": { "add_node": {}, "message": "Adding start node for 'Translate Design Text (Manual)' CUJ." },
                "step83": { "add_node": {}, "message": "Adding end node for 'Translate Design Text (Manual)' CUJ." },
                "step84": { "connect_nodes": { "node1": "node-55", "node2": "node-56" }, "message": "Connecting nodes for 'Translate Design Text (Manual)' CUJ." },
                "step85": { "add_node": {}, "message": "Adding end node for 'Translate Design Text (Tool)' CUJ." },
                "step86": { "connect_nodes": { "node1": "node-55", "node2": "node-57" }, "message": "Connecting nodes for 'Translate Design Text (Tool)' CUJ." },

                // CUJ: conduct_basic_accessibility_checks_figma
                "step87": { "add_node": {}, "message": "Adding start node for 'Accessibility Checks (Manual)' CUJ." },
                "step88": { "add_node": {}, "message": "Adding end node for 'Accessibility Checks (Manual)' CUJ." },
                "step89": { "connect_nodes": { "node1": "node-58", "node2": "node-59" }, "message": "Connecting nodes for 'Accessibility Checks (Manual)' CUJ." },
                "step90": { "add_node": {}, "message": "Adding end node for 'Accessibility Checks (Plugin)' CUJ." },
                "step91": { "connect_nodes": { "node1": "node-58", "node2": "node-60" }, "message": "Connecting nodes for 'Accessibility Checks (Plugin)' CUJ." },

                // ... (Add more CUJs in a similar pattern) ...

                "step92": { "message": "Additional CUJs connected.  Preparing for another round of potential compression/reorganization." },

                // Example of selecting nodes for another focus area operation (could be for different scales or task groups).
                "step93": { "select_path": ["node-1", "node-2", "node-4", "node-5", "node-8", "node-9"], "message": "Selecting end nodes of several CUJs for analysis." },
                "step94": { "copy_move_to_focus": null, "message": "Copying selected nodes to the observatory for further processing." },
                "step95": { "straighten_path": null, "message": "Straightening the copied nodes in the observatory (e.g., for comparison)." },
                // In a real script, you might *not* always compress.  Maybe you want to compare the spread.
                //"step96": { "compress_path": null, "message": "Compressing the path in the observatory." },
                "step97": { "add_node": { x: "center", y: "center+100" }, "message": "Adding a summary node for the analyzed CUJs in the main graph." },
                "step98": { "connect_nodes": { "node1": "node-61", "node2": "focus-0" }, "message": "Connecting the summary node to the first focus node." },
                "step99": { "connect_nodes": { "node1": "node-61", "node2": "focus-1" }, "message": "Connecting the summary node to the second focus node." },
                // ... (Continue connecting to other focus nodes) ...

                "step100": { "message": "Further CUJ analysis and connection. Adding new CUJs:" },
                // CUJ: generate_slide_deck_figma_frames
                "step101": { "add_node": {}, "message": "Adding start node for 'Generate Slide Deck (Manual)' CUJ." },
                "step102": { "add_node": {}, "message": "Adding end node for 'Generate Slide Deck (Manual)' CUJ." },
                "step103": { "connect_nodes": { "node1": "node-62", "node2": "node-63" }, "message": "Connecting nodes for 'Generate Slide Deck (Manual)' CUJ." },
                "step104": { "add_node": {}, "message": "Adding end node for 'Generate Slide Deck (Plugin)' CUJ." },
                "step105": { "connect_nodes": { "node1": "node-62", "node2": "node-64" }, "message": "Connecting nodes for 'Generate Slide Deck (Plugin)' CUJ." },

                // CUJ: create_user_flow_diagram_figma_screens
                "step106": { "add_node": {}, "message": "Adding start node for 'Create User Flow Diagram (Manual)' CUJ." },
                "step107": { "add_node": {}, "message": "Adding end node for 'Create User Flow Diagram (Manual)' CUJ." },
                "step108": { "connect_nodes": { "node1": "node-65", "node2": "node-66" }, "message": "Connecting nodes for 'Create User Flow Diagram (Manual)' CUJ." },
                "step109": { "add_node": {}, "message": "Adding end node for 'Create User Flow Diagram (Tool)' CUJ." },
                "step110": { "connect_nodes": { "node1": "node-65", "node2": "node-67" }, "message": "Connecting nodes for 'Create User Flow Diagram (Tool)' CUJ." },

                // CUJ: extract_design_tokens_figma
                "step111": { "add_node": {}, "message": "Adding start node for 'Extract Design Tokens (Manual)' CUJ." },
                "step112": { "add_node": {}, "message": "Adding end node for 'Extract Design Tokens (Manual)' CUJ." },
                "step113": { "connect_nodes": { "node1": "node-68", "node2": "node-69" }, "message": "Connecting nodes for 'Extract Design Tokens (Manual)' CUJ." },
                "step114": { "add_node": {}, "message": "Adding end node for 'Extract Design Tokens (Plugin)' CUJ." },
                "step115": { "connect_nodes": { "node1": "node-68", "node2": "node-70" }, "message": "Connecting nodes for 'Extract Design Tokens (Plugin)' CUJ." },

                // ... (Continue adding more CUJs) ...

                // Example: Another round of focus area operations.
                "step116": { "select_path": ["node-11", "node-12", "node-13", "node-15", "node-16"], "message": "Selecting end nodes related to placeholder generation and color extraction." },
                "step117": { "copy_move_to_focus": null, "message": "Copying selected nodes to the observatory." },
                //No straighten or compress, instead add a new node and connect
                "step118": { "add_node": { x: "center+100", y: "center+100" }, "message": "Adding a comparison node in the main graph." },
                "step119": { "connect_nodes": { "node1": "node-71", "node2": "focus-5" }, "message": "Connecting the comparison node to focus node 5." },
                "step120": { "connect_nodes": { "node1": "node-71", "node2": "focus-6" }, "message": "Connecting the comparison node to focus node 6." },
                // ... (Connect to other relevant focus nodes)

                // ... (Continue adding CUJs, performing focus operations, etc.) ...
                // CUJ: prototype_figma_to_code
                "step121": { "add_node": {}, "message": "Adding start node for 'Prototype to Code (Manual)' CUJ." },
                "step122": { "add_node": {}, "message": "Adding end node for 'Prototype to Code (Manual)' CUJ." },
                "step123": { "connect_nodes": { "node1": "node-72", "node2": "node-73" }, "message": "Connecting nodes for 'Prototype to Code (Manual)' CUJ." },
                "step124": { "add_node": {}, "message": "Adding end node for 'Prototype to Code (LLM-Assisted)' CUJ." },
                "step125": { "connect_nodes": { "node1": "node-72", "node2": "node-74" }, "message": "Connecting nodes for 'Prototype to Code (LLM-Assisted)' CUJ." },

                // CUJ: presentation_figma_to_slides
                "step126": { "add_node": {}, "message": "Adding start node for 'Presentation to Slides (Manual)' CUJ." },
                "step127": { "add_node": {}, "message": "Adding end node for 'Presentation to Slides (Manual)' CUJ." },
                "step128": { "connect_nodes": { "node1": "node-75", "node2": "node-76" }, "message": "Connecting nodes for 'Presentation to Slides (Manual)' CUJ." },
                "step129": { "add_node": {}, "message": "Adding end node for 'Presentation to Slides (Live Link)' CUJ." },
                "step130": { "connect_nodes": { "node1": "node-75", "node2": "node-77" }, "message": "Connecting nodes for 'Presentation to Slides (Live Link)' CUJ." },

                // ... (Continue adding more CUJs) ...
                "step131": { "select_path": ["node-73", "node-74", "node-76", "node-77"], "message": "select nodes for to code and slide handoff" },
                "step132": { "copy_move_to_focus": null, "message": "copy and move  nodes  73 74, 76, 77 to focus" },
                "step133": { "straighten_path": null, "message": "straightening path in focus" },
                "step134": { "add_node": { x: "center", y: "center+250" }, "message": "Adding a comparison node in the main graph." },
                "step135": { "connect_nodes": { "node1": "node-78", "node2": "focus-7" }, "message": "Connecting the comparison node to focus node 7." },
                "step136": { "connect_nodes": { "node1": "node-78", "node2": "focus-8" }, "message": "Connecting the comparison node to focus node 8." },
                "step137": { "connect_nodes": { "node1": "node-78", "node2": "focus-9" }, "message": "Connecting the comparison node to focus node 9." },
                "step138": { "connect_nodes": { "node1": "node-78", "node2": "focus-10" }, "message": "Connecting the comparison node to focus node 10." },


                // ... (Continue adding CUJs, performing focus operations, etc., up to at least step 200) ...
                // CUJ: export_thoughts_drawings_to_figma
                "step139": { "add_node": {}, "message": "Adding start node for 'Thoughts to Figma (Manual)' CUJ." },
                "step140": { "add_node": {}, "message": "Adding end node for 'Thoughts to Figma (Manual)' CUJ." },
                "step141": { "connect_nodes": { "node1": "node-79", "node2": "node-80" }, "message": "Connecting nodes for 'Thoughts to Figma (Manual)' CUJ." },
                "step142": { "add_node": {}, "message": "Adding end node for 'Thoughts to Figma (Handwriting Recognition)' CUJ." },
                "step143": { "connect_nodes": { "node1": "node-79", "node2": "node-81" }, "message": "Connecting nodes for 'Thoughts to Figma (Handwriting Recognition)' CUJ." },

                // CUJ: design_to_production_code_iterative
                "step144": { "add_node": {}, "message": "Adding start node for 'Design to Production Code (Manual)' CUJ." },
                "step145": { "add_node": {}, "message": "Adding end node for 'Design to Production Code (Manual)' CUJ." },
                "step146": { "connect_nodes": { "node1": "node-82", "node2": "node-83" }, "message": "Connecting nodes for 'Design to Production Code (Manual)' CUJ." },
                "step147": { "add_node": {}, "message": "Adding end node for 'Design to Production Code (Integrated Platform)' CUJ." },
                "step148": { "connect_nodes": { "node1": "node-82", "node2": "node-84" }, "message": "Connecting nodes for 'Design to Production Code (Integrated Platform)' CUJ." },

                // CUJ: design_to_research_experiment_ab_test
                "step149": { "add_node": {}, "message": "Adding start node for 'Design to A/B Test (Manual)' CUJ." },
                "step150": { "add_node": {}, "message": "Adding end node for 'Design to A/B Test (Manual)' CUJ." },
                "step151": { "connect_nodes": { "node1": "node-85", "node2": "node-86" }, "message": "Connecting nodes for 'Design to A/B Test (Manual)' CUJ." },
                "step152": { "add_node": {}, "message": "Adding end node for 'Design to A/B Test (Tool Integration)' CUJ." },
                "step153": { "connect_nodes": { "node1": "node-85", "node2": "node-87" }, "message": "Connecting nodes for 'Design to A/B Test (Tool Integration)' CUJ." },

                // ... Continue adding and connecting CUJs and performing operations ...

                "step154": { "select_path": ["node-80", "node-81", "node-83", "node-84", "node-86", "node-87"], "message": "Selecting end nodes for several CUJs to prepare for another focus area operation." },
                "step155": { "copy_move_to_focus": null, "message": "Moving the newly selected nodes to the focus area for comparison/analysis." },
                "step156": { "straighten_path": null, "message": "Straightening selected in focus" },

                "step157": { "add_node": { x: "center-200", y: "center+100" }, "message": "adding new node" },
                "step158": { "add_node": { x: "center+200", y: "center-100" }, "message": "adding new node" },
                "step159": { "add_node": { x: "center-100", y: "center-50" }, "message": "adding new node" },
                "step160": { "add_node": { x: "center-50", y: "center" }, "message": "adding new node" },
                "step161": { "add_node": { x: "center-100", y: "center+50" }, "message": "adding new node" },
                "step162": { "connect_nodes": { "node1": "node-88", "node2": "focus-11" }, "message": "Connecting the comparison node to focus node 11." },
                "step163": { "connect_nodes": { "node1": "node-89", "node2": "focus-12" }, "message": "Connecting the comparison node to focus node 12." },
                "step164": { "connect_nodes": { "node1": "node-90", "node2": "focus-13" }, "message": "Connecting the comparison node to focus node 13." },

                // ... Continue up to at least step 200, adding CUJs, connections, and focus operations ...
                "step165": { "add_node": {}, "message": "Adding start node" },
                "step166": { "add_node": {}, "message": "Adding end node" },
                "step167": { "connect_nodes": { "node1": "node-91", "node2": "node-92" }, "message": "connecting nodes" },
                "step168": { "add_node": {}, "message": "Adding end node" },
                "step169": { "connect_nodes": { "node1": "node-91", "node2": "node-93" }, "message": "connecting nodes" },
                "step170": { "add_node": {}, "message": "Adding start node" },
                "step171": { "add_node": {}, "message": "Adding end node" },
                "step172": { "connect_nodes": { "node1": "node-94", "node2": "node-95" }, "message": "connecting nodes" },
                "step173": { "add_node": {}, "message": "Adding end node" },
                "step174": { "connect_nodes": { "node1": "node-94", "node2": "node-96" }, "message": "connecting nodes" },
                "step175": { "add_node": {}, "message": "Adding start node" },
                "step176": { "add_node": {}, "message": "Adding end node" },

            }
        }


        function setupObservatory() {
            observatorySvg.innerHTML = '';
            const observatoryFragment = document.createDocumentFragment();

            const currentStepMessageTextElem = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            currentStepMessageTextElem.setAttribute('id', 'currentStepMessage');
            currentStepMessageTextElem.setAttribute('class', 'step-message');
            currentStepMessageTextElem.setAttribute('x', '50%');
            currentStepMessageTextElem.setAttribute('y', '10');
            observatoryFragment.appendChild(currentStepMessageTextElem);

            const messageHistoryGroupElem = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            messageHistoryGroupElem.setAttribute('id', 'messageHistory');
            observatoryFragment.appendChild(messageHistoryGroupElem);

            observatorySvg.appendChild(observatoryFragment);

            currentStepMessage = document.getElementById('currentStepMessage');
            messageHistory = document.getElementById('messageHistory');
        }

        function renderGraph() {
            mainSvg.innerHTML = '';
            const mainFragment = document.createDocumentFragment();

            edges.forEach(edge => {
                const node1 = nodes.find(node => node.id === edge.node1Id);
                const node2 = nodes.find(node => node.id === edge.node2Id);
                if (node1 && node2) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('class', 'edge');
                    line.setAttribute('x1', node1.x);
                    line.setAttribute('y1', node1.y);
                    line.setAttribute('x2', node2.x);
                    line.setAttribute('y2', node2.y);
                    line.setAttribute('data-edge-id', edge.id);
                    mainFragment.appendChild(line);
                }
            });

            focusEdges.forEach(edge => {
                const node1 = focusNodes.find(node => node.id === edge.node1Id);
                const node2 = focusNodes.find(node => node.id === edge.node2Id);
                if (node1 && node2) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('class', 'edge focus-edge');
                    line.setAttribute('x1', node1.x);
                    line.setAttribute('y1', node1.y);
                    line.setAttribute('x2', node2.x);
                    line.setAttribute('y2', node2.y);
                    line.setAttribute('data-edge-id', edge.id);
                    mainFragment.appendChild(line);
                }
            });

            focusNodes.forEach(node => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('class', 'node focus-node');
                circle.setAttribute('cx', node.x);
                circle.setAttribute('cy', node.y);
                circle.setAttribute('r', 8);
                circle.setAttribute('data-focus-node-id', node.id);
                mainFragment.appendChild(circle);
            });

            nodes.forEach(node => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('class', 'node');
                circle.setAttribute('cx', node.x);
                circle.setAttribute('cy', node.y);
                circle.setAttribute('r', 10);
                circle.setAttribute('data-node-id', node.id);
                circle.classList.toggle('selected', selectedNodeIds.includes(node.id));
                circle.addEventListener('click', () => onNodeClick(node.id));
                mainFragment.appendChild(circle);
            });

            mainSvg.appendChild(mainFragment);
        }

        function createNode(config) {
            const canvasRect = graphCanvas.getBoundingClientRect();
            let calculatedX = config.x || Math.random() * graphCanvas.clientWidth;
            let calculatedY = config.y || Math.random() * (graphCanvas.clientHeight);

            if (typeof calculatedX === 'string' && calculatedX.startsWith('center')) {
                calculatedX = graphCanvas.clientWidth / 2 + parseInt(calculatedX.split('-')[1] || 0, 10);
            } else if (typeof calculatedX === 'string' && calculatedX === 'center') {
                calculatedX = graphCanvas.clientWidth / 2;
            } else {
                calculatedX = parseFloat(calculatedX);
            }

            if (typeof calculatedY === 'string' && calculatedY.startsWith('center')) {
                calculatedY = (graphCanvas.clientHeight) / 2 + parseInt(calculatedY.split('-')[1] || 0, 10);
            } else if (typeof calculatedY === 'string' && calculatedY === 'center') {
                calculatedY = (graphCanvas.clientHeight) / 2;
            } else {
                calculatedY = parseFloat(calculatedY);
            }

            const nodeId = config.id || `node-${nextNodeId++}`;
            const node = { id: nodeId, x: calculatedX, y: calculatedY, label: config.label, type: config.type };
            nodes.push(node);
            renderGraph();
            return nodeId;
        }

        function removeNode(nodeId) {
            nodes = nodes.filter(node => node.id !== nodeId);
            edges = edges.filter(edge => edge.node1Id !== nodeId && edge.node2Id !== nodeId);
            renderGraph();
        }

        function createEdge(node1Id, node2Id) {
            if (!node1Id || !node2Id) {
                return;
            }
            if (nodes.findIndex(n => n.id === node1Id) === -1 || nodes.findIndex(n => n.id === node2Id) === -1) {
                return;
            }

            const edge = { id: `edge-${nextEdgeId++}`, node1Id: node1Id, node2Id: node2Id };
            edges.push(edge);
            renderGraph();
        }

        function removeEdge(edgeId) {
            edges = edges.filter(edge => edge.id !== edgeId);
            renderGraph();
        }

        function onNodeClick(nodeId) {
            if (isConnectingNodes) {
                if (!selectedNodeIdForConnection) {
                    selectedNodeIdForConnection = nodeId;
                    highlightNode(nodeId);
                } else if (selectedNodeIdForConnection !== nodeId) {
                    createEdge(selectedNodeIdForConnection, nodeId);
                    clearNodeHighlight(selectedNodeIdForConnection);
                    selectedNodeIdForConnection = null;
                    isConnectingNodes = false;
                    connectNodesButton.textContent = 'Connect Nodes';
                } else {
                    clearNodeHighlight(selectedNodeIdForConnection);
                    selectedNodeIdForConnection = null;
                }
            } else {
                if (selectedNodeIds.includes(nodeId)) {
                    selectedNodeIds = selectedNodeIds.filter(id => id !== nodeId);
                } else {
                    selectedNodeIds.push(nodeId);
                }
                renderGraph();
            }
        }

        function highlightNode(nodeId) {
            const nodeIndex = nodes.findIndex(node => node.id === nodeId);
            if (nodeIndex !== -1) {
                selectedNodeIds.push(nodeId);
                renderGraph();
            }
        }

        function clearNodeHighlight(nodeId) {
            selectedNodeIds = selectedNodeIds.filter(id => id !== nodeId);
            renderGraph();
        }

        function applyRingLayout(ringSizes) {
            nodes = [];
            edges = [];
            nextNodeId = 0;
            nextEdgeId = 0;
            selectedNodeIds = [];
            resetFocusArea();
            const centerX = graphCanvas.clientWidth / 2;
            const centerY = (graphCanvas.clientHeight) / 2;
            let currentRadius = 40;
            const minNodeSpacing = 40;
            let previousRingNodes = 0;
            const initialRingRadiusIncrement = Math.min(centerX, centerY) * 0.15;
            let createdNodeIds = [];

            ringSizes.forEach((numNodes, index) => {
                let ringRadiusIncrement;
                if (index === 0) {
                    ringRadiusIncrement = initialRingRadiusIncrement;
                } else {
                    ringRadiusIncrement = Math.max(minNodeSpacing * previousRingNodes / (2 * Math.PI), currentRadius * 0.3);
                }
                currentRadius += ringRadiusIncrement;
                const angleStep = (2 * Math.PI) / numNodes;
                for (let i = 0; i < numNodes; i++) {
                    const angle = i * angleStep;
                    const x = centerX + currentRadius * Math.cos(angle);
                    const y = centerY + currentRadius * Math.sin(angle);
                    createdNodeIds.push(createNode({ x: x, y: y }));
                }
                previousRingNodes = numNodes;
            });
            renderGraph();
            return createdNodeIds;
        }

        function applyTriangularGridLayout(numRings) {
            nodes = [];
            edges = [];
            nextNodeId = 0;
            nextEdgeId = 0;
            selectedNodeIds = [];
            resetFocusArea();
            const centerX = graphCanvas.clientWidth / 2;
            const centerY = (graphCanvas.clientHeight) / 2;
            const nodeSpacing = Math.min(centerX, centerY) * 0.2;
            let createdNodeIds = [];

            for (let ring = 0; ring < numRings; ring++) {
                let nodesInRing = ring === 0 ? 1 : 6 * ring;
                for (let i = 0; i < nodesInRing; i++) {
                    let angle = (2 * Math.PI / nodesInRing) * i - (ring % 2 === 0 ? 0 : Math.PI / 6);
                    let x = centerX + nodeSpacing * ring * Math.cos(angle);
                    let y = centerY + nodeSpacing * ring * Math.sin(angle);
                    createdNodeIds.push(createNode({ x: x, y: y }));
                }
            }
            renderGraph();
            return createdNodeIds;
        }

        function resetGraph() {
            nodes = [];
            edges = [];
            nextNodeId = 0;
            nextEdgeId = 0;
            selectedNodeIds = [];
            resetFocusArea();
            renderGraph();
        }

        function resetFocusArea() {
            focusNodes = [];
            focusEdges = [];
            nextFocusNodeId = 0;
            nextFocusEdgeId = 0;
        }

        function toggleDarkMode() {
            darkMode = !darkMode;
            document.body.classList.toggle('light-mode', !darkMode);
            darkModeToggleContainer.classList.toggle('dark-mode', darkMode);
        }

        function loadScript(scriptName) {
            currentScript = scripts[scriptName];
            if (currentScript) {
                scriptSteps = Object.entries(currentScript).sort((a, b) => parseInt(a[0].substring(4)) - parseInt(b[0].substring(4)));
                currentStepIndex = -1;
                resetGraph();
                stopPlaying();
                stepForward();
                updateStepDisplay();
            } else {
                scriptSteps = [];
                currentStepIndex = -1;
                updateStepDisplay();
            }
        }

        function executeStep(step) {
            if (!step) return;
            console.log("Executing step:", step);

            if (step.message) {
                messageHistoryArray.push(step.message);
                if (messageHistoryArray.length > 3) messageHistoryArray.shift();
                updateMessageDisplay();
            }

            if (step.reset !== undefined && step.reset === null) {
                resetGraph();
            }
            if (step.add_circular_rings) {
                applyRingLayout(step.add_circular_rings);
            }
            if (step.add_triangular_grid) {
                applyTriangularGridLayout(step.add_triangular_grid);
            }
            if (step.add_node) {
                createNode(step.add_node);
            }
            if (step.remove_node !== undefined && step.remove_node === null) {
                if (nodes.length > 0) {
                    removeNode(nodes[nodes.length - 1].id);
                }
            }
            if (step.connect_nodes) {
                const node1Id = step.connect_nodes.node1;
                const node2Id = step.connect_nodes.node2;
                createEdge(node1Id, node2Id);
            }
            if (step.select_path) {
                selectPath(step.select_path);
            }
            if (step.copy_move_to_focus) {
                copyMovePathToFocus();
            }
            if (step.straighten_path) {
                straightenPathInFocus();
            }
            if (step.compress_path) {
                compressPathInFocus();
            }
            if (step.add_compressed_path_to_graph) {
                addCompressedPathToGraph();
            }

            renderGraph();
        }

        function stepForward() {
            stopPlaying();
            if (currentStepIndex < scriptSteps.length - 1) {
                currentStepIndex++;
                executeStep(scriptSteps[currentStepIndex][1]);
                updateStepDisplay();
            } else {
                stopPlaying();
                isPlaying = false;
                playPauseButton.textContent = 'Play';
            }
        }

        function stepBackward() {
            stopPlaying();
            if (currentStepIndex > 0) {
                currentStepIndex--;
                executeStep(scriptSteps[currentStepIndex][1]);
                updateStepDisplay();
            } else if (currentStepIndex === 0) {
                currentStepIndex--;
                resetGraph();
                updateStepDisplay();
            }
        }

        function playScript() {
            if (isPlaying) {
                stopPlaying();
            } else {
                isPlaying = true;
                playPauseButton.textContent = 'Pause';
                if (currentStepIndex >= scriptSteps.length - 1) {
                    currentStepIndex = -1;
                    resetGraph();
                    updateStepDisplay();
                }
                playInterval = setInterval(() => {
                    stepForward();
                    if (currentStepIndex >= scriptSteps.length - 1) stopPlaying();
                }, playSpeed);
            }
        }

        function stopPlaying() {
            isPlaying = false;
            playPauseButton.textContent = 'Play';
            clearInterval(playInterval);
        }

        function togglePlayPause() {
            if (isPlaying) {
                stopPlaying();
            } else {
                playScript();
            }
        }

        function updateStepDisplay() {
            scriptStepDisplay.textContent = `Step: ${currentStepIndex + 1}/${scriptSteps.length > 0 ? scriptSteps.length : '-'}`;
        }

        function updateMessageDisplay() {
            if (currentStepMessage) {
                currentStepMessage.textContent = scriptSteps[currentStepIndex]?.[1]?.message || "";
                currentStepMessage.classList.add('visible');
                setTimeout(() => {
                    if (currentStepMessage) {
                        currentStepMessage.classList.remove('visible');
                    }
                }, stepDelay * 3);
            }

            if (messageHistory) {
                messageHistory.innerHTML = '';
                messageHistoryArray.forEach((msg, index) => {
                    const textElem = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElem.setAttribute('class', 'message-history');
                    textElem.setAttribute('x', '50%');
                    textElem.setAttribute('y', 40 + (index * 15));
                    textElem.textContent = msg;
                    messageHistory.appendChild(textElem);
                });
            }
        }

        function selectPath(pathIds) {
            selectedNodeIds = [];
            pathIds.forEach(id => {
                const node = nodes.find(n => n.id === id);
                if (node) selectedNodeIds.push(node.id);
            });
            renderGraph();
        }

        function copyMovePathToFocus() {
            resetFocusArea();

            const graphCanvasRect = graphCanvas.getBoundingClientRect();
            const observatoryRect = observatory.getBoundingClientRect();

            // Create copies of selected nodes for the focus area
            focusNodes = selectedNodeIds.map((nodeId, index) => {
                const originalNode = nodes.find(n => n.id === nodeId);
                if (originalNode) {
                    return {
                        ...originalNode, // Copy all properties from the original node
                        id: `focus-${index}`, // Assign a unique ID for the focus node
                        x: originalNode.x,     // initial positions
                        y: originalNode.y      // initial positions
                    };
                }
                return null; // Handle cases where the original node might not be found
            }).filter(node => node); // Remove null entries (if any)


            // Define target positions *before* the animation loop
            const targetPositions = focusNodes.map((node, index) => {
                const targetX = observatoryRect.left + 20 - graphCanvasRect.left + (observatoryRect.width - 40) * (index / (focusNodes.length - 1 || 1));
                const targetY = observatoryRect.top + observatoryRect.height / 2 - graphCanvasRect.top;
                return { x: targetX, y: targetY };
            });

            // Animate each node individually
            focusNodes.forEach((node, index) => {
                let startX = node.x; //  starting positions
                let startY = node.y;
                const targetX = targetPositions[index].x; //  target positions
                const targetY = targetPositions[index].y;
                let animationStartTime = null;


                function animate(currentTime) {
                    if (!animationStartTime) animationStartTime = currentTime;
                    const elapsedTime = currentTime - animationStartTime;
                    const progress = Math.min(1, elapsedTime / 500); // 500ms

                    // Interpolate positions
                    node.x = startX + (targetX - startX) * progress;
                    node.y = startY + (targetY - startY) * progress;


                    if (progress < 1) {
                        requestAnimationFrame(animate); // Continue animation
                    } else {
                        // Final positions after animation
                        node.x = targetX;
                        node.y = targetY;
                    }
                    renderGraph(); // Re-render on EACH frame for EACH node
                }


                requestAnimationFrame(animate);
            });

            // Create focus edges based on focus nodes
            focusEdges = [];
            for (let i = 0; i < focusNodes.length - 1; i++) {
                focusEdges.push({ id: `focus-edge-${nextFocusEdgeId++}`, node1Id: focusNodes[i].id, node2Id: focusNodes[i + 1].id });
            }

        }
        function positionFocusNodes() {
            const observatoryRect = observatory.getBoundingClientRect();
            const graphCanvasRect = graphCanvas.getBoundingClientRect();

            const startX = observatoryRect.left + 20 - graphCanvasRect.left;
            const endX = observatoryRect.right - 20 - graphCanvasRect.left;
            const yPos = (observatoryRect.height / 2);

            focusNodes.forEach((node, index) => {
                node.y = yPos;
                node.x = startX + (endX - startX) * (index / (focusNodes.length - 1 || 1));
            });
            renderGraph();
        }

        function straightenPathInFocus() {
            positionFocusNodes();
        }

        function compressPathInFocus() {
            if (focusNodes.length > 2) {
                const firstNode = focusNodes[0];
                const lastNode = focusNodes[focusNodes.length - 1];
                resetFocusArea();
                focusNodes = [firstNode, lastNode];
                focusEdges = [{ id: `focus-edge-${nextFocusEdgeId++}`, node1Id: focusNodes[0].id, node2Id: focusNodes[1].id }];
                positionFocusNodes();
                renderGraph();
            }
        }

        function addCompressedPathToGraph() {
            if (focusNodes.length === 2) {
                const startFocusNode = focusNodes[0];
                const endFocusNode = focusNodes[1];

                const startGraphNode = createNode({ x: startFocusNode.x + controls.getBoundingClientRect().width, y: startFocusNode.y + observatory.getBoundingClientRect().height, label: startFocusNode.label + " Start", type: startFocusNode.type + "Start" });
                const endGraphNode = createNode({ x: endFocusNode.x + controls.getBoundingClientRect().width, y: endFocusNode.y + observatory.getBoundingClientRect().height, label: endFocusNode.label + " End", type: endFocusNode.type + "End" });
                createEdge(startGraphNode, endGraphNode);
                resetFocusArea();
                renderGraph();
            }
        }

        function populateScriptSelector() {
            scriptSelector.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select Script';
            scriptSelector.appendChild(defaultOption);

            for (const scriptName in scripts) {
                if (scripts.hasOwnProperty(scriptName)) {
                    const option = document.createElement('option');
                    option.value = scriptName;
                    option.textContent = scriptName;
                    scriptSelector.appendChild(option);
                }
            }
        }

        darkModeToggleContainer.addEventListener('click', toggleDarkMode);
        resetButton.addEventListener('click', () => { resetGraph(); });
        addNodeButton.addEventListener('click', () => { createNode({}); });
        removeNodeButton.addEventListener('click', () => { if (nodes.length > 0) removeNode(nodes[nodes.length - 1].id); });
        connectNodesButton.addEventListener('click', () => {
            isConnectingNodes = !isConnectingNodes;
            connectNodesButton.textContent = isConnectingNodes ? 'Connecting...' : 'Connect Nodes';
            if (!isConnectingNodes) {
                selectedNodeIdForConnection = null;
                clearNodeHighlight(selectedNodeIdForConnection);
            }
        });
        addRingsButton.addEventListener('click', () => {
            try {
                const ringSizes = JSON.parse(ringNodesInput.value);
                if (Array.isArray(ringSizes) && ringSizes.every(Number.isInteger) && ringSizes.every(size => size > 0)) {
                    applyRingLayout(ringSizes);
                }
            } catch (e) {
            }
        });
        addTriGridButton.addEventListener('click', () => {
            const numRings = parseInt(triGridRingsInput.value, 10);
            if (Number.isInteger(numRings) && numRings > 0) {
                applyTriangularGridLayout(numRings);
            }
        });
        scriptSelector.addEventListener('change', (event) => { loadScript(event.target.value); });
        stepForwardButton.addEventListener('click', () => { stepForward(); });
        stepBackwardButton.addEventListener('click', () => { stepBackward(); });
        playPauseButton.addEventListener('click', () => { togglePlayPause(); });
        speedSlider.addEventListener('input', (event) => {
            playSpeed = parseInt(event.target.value, 10);
            stepDelay = playSpeed;
            if (isPlaying) { stopPlaying(); playScript(); }
            speedLabel.textContent = `Step Speed (${playSpeed}ms)`;
        });

        populateScriptSelector();
        setupObservatory();
        renderGraph();
        darkMode = true;
        updateStepDisplay();
        scriptSelector.value = "ring_demo";
        loadScript("ring_demo");
    </script>

</body>

</html>